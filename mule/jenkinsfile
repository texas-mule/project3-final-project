pipeline {

  agent any
  
  environment {
        ANYPOINT_CREDENTIALS = credentials('anypoint.credentials')
  }
  
  tools {
        maven 'default'
  }
  
	  	stages {
		    stage('Build'){
			steps {
			  sh 'mvn -f mule/pom.xml -DskipTests clean verify compile'
	        	}
		    }
		    stage('Test') {
		      steps {
		        sh 'mvn -f mule/pom.xml test'
		      }
		    }
		   stage('Deploy CloudHub') {
		      steps {
		         configFileProvider([configFile(fileId: 'a27cc7ec-5739-4e7a-920c-7043cb601d0b', targetLocation: 'mule/src/main/resources/config.yaml')]) {
		      	    sh 'mvn -f mule/pom.xml -B -DskipTests package -DattachMuleSources'
			        sh 'mvn -f mule/pom.xml deploy -DmuleDeploy -U -Dmule.version=4.2.0 -Danypoint.username=${ANYPOINT_CREDENTIALS_USR} -Danypoint.password=${ANYPOINT_CREDENTIALS_PSW}'   
		        }
		      }
		   }
	}
}
